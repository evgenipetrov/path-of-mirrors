# Production Docker Compose configuration
#
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# This file configures services for production deployment with:
# - Production-grade restart policies
# - Resource limits
# - Security hardening
# - No volume mounts (code baked into image)

services:
  postgres:
    restart: unless-stopped
    # Production: use named volumes for persistence
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    # Production: tune healthcheck for lower overhead
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    restart: unless-stopped
    volumes:
      - redis_data_prod:/data
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    restart: unless-stopped
    # Production: build from production target
    build:
      target: production
    # Production: no volume mounts (code is in image)
    volumes: []
    # Production: use gunicorn with multiple workers
    command: >
      gunicorn src.main:app
      --worker-class uvicorn.workers.UvicornWorker
      --workers 4
      --bind 0.0.0.0:8000
      --access-logfile -
      --error-logfile -
    environment:
      ENVIRONMENT: production
      LOG_LEVEL: WARNING

volumes:
  postgres_data_prod:
  redis_data_prod:
